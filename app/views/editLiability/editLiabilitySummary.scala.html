@*
 * Copyright 2022 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import _root_.utils.PeriodUtils._
@import config.ApplicationConfig
@import play.twirl.api.HtmlFormat
@import views.ViewUtils.titleBuilder
@import views.html.helpers.formattedPounds

@this(newMain: newMain,
        formHelper: FormWithCSRF,
        govukSummaryList: GovukSummaryList,
        govukButton : GovukButton,
        govukBackLink : GovukBackLink,
        govukInsetText: GovukInsetText)

@(changeLiability: models.PropertyDetails,
        returnType: String,
        periods : Seq[models.LineItem],
        valuesToDisplay: Seq[models.LineItemValue],
        serviceInfoContent: Html = HtmlFormat.empty,
        backLink: Option[String]
)(implicit authContext: StandardAuthRetrievals,
        messages: Messages,
        request: Request[AnyContent],
        appConfig: ApplicationConfig)

@incomplete = {
@messages("ated.label.incomplete")
}

@backLinkHtml = {
@if(backLink.isDefined) {
  @govukBackLink(BackLink(
    href = backLink.get,
    content = Text("Back")
  ))
}
}

@summaryContent = {
  <div>
    <span id="address-line-1">@changeLiability.addressProperty.line_1</span><br>
    <span id="address-line-2">@changeLiability.addressProperty.line_2</span><br>
    @if(changeLiability.addressProperty.line_3.isDefined) {
      <span id="address-line-3">@changeLiability.addressProperty.line_3</span>
      <br/>
    }
    @if(changeLiability.addressProperty.line_4.isDefined) {
      <span id="address-line-4">@changeLiability.addressProperty.line_4</span>
      <br/>
    }
    @if(changeLiability.addressProperty.postcode.isDefined) {
      <span id="address-postcode">@changeLiability.addressProperty.postcode</span>
    }
  </div>
}

@newMain(title = titleBuilder(messages("ated.property-details-summary.title")),
  serviceInfoContent = serviceInfoContent) {

  @backLinkHtml

  <header>
    <h1 id="edit-liability-summary-header" class="govuk-heading-xl">
      <span class="govuk-caption-xl">
        <span class="govuk-visually-hidden">
        @messages("ated.screen-reader.section")
        </span>
        @messages("ated.property-details.pre-header-change")
      </span>
      @messages("ated.property-details-summary.header")
    </h1>
  </header>

  <div class="govuk-form-group">
    <p id="details-text" class="govuk-body">@messages("ated.property-details-summary.details-text", periodStartDate(changeLiability.periodKey).toString(messages("ated.date-format")), periodEndDate(changeLiability.periodKey).toString(messages("ated.date-format")))</p>
  </div>

  <div class="govuk-form-group" id="property-summary">
    <div class="grid-wrapper">
      <h2 id="edit-liability-header" class="govuk-heading-m">@messages("ated.property-details-summary.table.property-details.header")</h2>
    </div>

    @govukSummaryList(SummaryList(
      rows = Seq(
        SummaryListRow(
          key = Key(
            content = Text(messages("ated.property-details-summary.table.property-details.address.label"))
          ),
          value = Value(
            content = HtmlContent(summaryContent)
          ),
          actions = Some(Actions(
            items = Seq(
              ActionItem(
                href = controllers.propertyDetails.routes.PropertyDetailsAddressController.editFromSummary(changeLiability.id).url,
                content = Text(messages("ated.edit")),
                visuallyHiddenText = Some(messages("ated.property-details-summary.table.property-details.address.label"))
              )
            )
          ))
        )
      ),
      attributes = Map("id" -> "property-address-label")
    ))

    @govukSummaryList(SummaryList(
      rows = Seq(
        SummaryListRow(
          key = Key(
            content = Text(messages("ated.property-details-summary.table.property-details.title-number.label"))
          ),
          value = Value(
            content = Text(changeLiability.title.map(_.titleNumber).fold(messages("ated.property-details-summary.field-blank"))(x => if(x == "") messages("ated.property-details-summary.field-blank") else x))
          ),
          actions = Some(Actions(
            items = Seq(
              ActionItem(
                href = controllers.propertyDetails.routes.PropertyDetailsTitleController.editFromSummary(changeLiability.id).url,
                content = Text(messages("ated.edit")),
                visuallyHiddenText = Some(messages("ated.property-details-summary.table.property-details.title-number.label"))
              )
            )
          ))
        )
      ),
      attributes = Map("id" -> "property-title-number-label")
    ))
  </div>

  <div class="govuk-form-group">
    <div class="grid-wrapper">
      <h2 id="property-value-header" class="govuk-heading-m">@messages("ated.property-details-summary.table.property-value.header")</h2>
    </div>

    @for((valueObj, index) <- valuesToDisplay.zipWithIndex) {

      @govukSummaryList(SummaryList(
        rows = Seq(
          SummaryListRow(
            key = Key(
              content = Text(messages(getPeriodValueMessage(index, valuesToDisplay.size)))
            ),
            value = Value(
              content = HtmlContent(formattedPounds(valueObj.propertyValue))
            ),
            actions = Some(Actions(
              items = Seq(
                ActionItem(
                  href = controllers.editLiability.routes.EditLiabilityHasValueChangedController.editFromSummary(changeLiability.id.toString).url,
                  content = Text(messages("ated.edit")),
                  visuallyHiddenText = Some(messages(getPeriodValueMessage(index, valuesToDisplay.size)))
                )
              )
            ))
          )
        ),
        attributes = Map("id" -> "property-value-label-0")
      ))

      @govukSummaryList(SummaryList(
        rows = Seq(
          SummaryListRow(
            key = Key(
              content = Text(messages("ated.form-bundle.view.isValuedByAgent.message"))
            ),
            value = Value {
              if(changeLiability.value.map(x => x.isValuedByAgent.getOrElse()).contains(true)) {
                Text(messages("ated.form-bundle.view.isValuedByAgent.yes"))
              } else {
                Text(messages("ated.form-bundle.view.isValuedByAgent.no"))
              }
            },
            actions = Some(Actions(
              items = Seq(
                ActionItem(
                  href = controllers.propertyDetails.routes.PropertyDetailsProfessionallyValuedController.view(changeLiability.id).url,
                  content = Text(messages("ated.edit")),
                  visuallyHiddenText = Some(messages("ated.form-bundle.view.isValuedByAgent.message"))
                )
              )
            ))
          )
        ),
        attributes = Map("id" -> "property-date-of-valuation-label-0")
      ))
    }
  </div>

  <div class="govuk-form-group">

    <div class="grid-wrapper">
      <h2 id="bank-details-header" class="govuk-heading-m">@messages("ated.edit-liability.summary.bank-details.header")</h2>
    </div>

  @if(changeLiability.bankDetails.map(_.hasBankDetails) == Some(true)) {

    @govukSummaryList(SummaryList(
      rows = Seq(
        SummaryListRow(
          key = Key(
            content = Text(messages("ated.edit-liability.summary.bank-details.header"))
          ),
          actions = Some(Actions(
            items = Seq(
              ActionItem(
                href = controllers.editLiability.routes.HasBankDetailsController.editFromSummary(changeLiability.id.toString).url,
                content = Text(messages("ated.edit")),
                visuallyHiddenText = Some(messages("ated.edit-liability.summary.bank-details.header"))
              )
            )
          ))
        ),
        SummaryListRow(
          key = Key(
            content = Text(messages("ated.edit-liability.summary.bank-details.account-holder-name"))
          ),
          value = Value {
            Text(changeLiability.bankDetails.flatMap(_.bankDetails.map(_.accountName)).flatten.getOrElse(""))
          }
        )
      ),
      attributes = Map("id" -> "account-holder-name-label")
    )
    )

    @if(changeLiability.bankDetails.flatMap(_.bankDetails.flatMap(_.hasUKBankAccount)) == Some(true)) {

      @govukSummaryList(SummaryList(
        rows = Seq(
          SummaryListRow(
            key = Key(
              content = Text(messages("ated.edit-liability.summary.bank-details.account-number"))
            ),
            value = Value(
              Text(changeLiability.bankDetails.flatMap(_.bankDetails.map(_.accountNumber)).flatten.getOrElse(""))
            )
          ),
          SummaryListRow(
            key = Key(
              content = Text(messages("ated.edit-liability.summary.bank-details.sort-code"))
            ),
            value = Value(
              Text(changeLiability.bankDetails.flatMap(_.bankDetails.map(_.sortCode)).flatten.getOrElse("").toString)
            )
          )
        )
      )
      )
    } else {
      @govukSummaryList(SummaryList(
        rows = Seq(
          SummaryListRow(
            key = Key(
              content = Text(messages("ated.edit-liability.summary.bank-details.iban"))
            ),
            value = Value(
              Text(changeLiability.bankDetails.flatMap(_.bankDetails.map(_.iban)).flatten.getOrElse("").toString)
            )
          ),
          SummaryListRow(
            key = Key(
              content = Text(messages("ated.edit-liability.summary.bank-details.bic-swift-code"))
            ),
            value = Value(
              Text(changeLiability.bankDetails.flatMap(_.bankDetails.map(_.bicSwiftCode)).flatten.getOrElse("").toString)
            )
          )
        )
      )
      )
    }
  }
  </div>

  <div class="govuk-!-margin-top-9">

    <h2 id="dates-of-liability-header" class="govuk-heading-m">@messages("ated.property-details-summary.table.dates-of-liability.header")</h2>

    @for((period, index) <- periods.zipWithIndex) {

      @govukSummaryList(SummaryList(
        rows = Seq(
          SummaryListRow(
            key = Key(
              content = Text(messages(period.description.getOrElse("")))
            ),
            value = Value(
              content = Text(messages("ated.property-details-summary.table.period.text",
                period.startDate.toString(messages("ated.date-format")),
                period.endDate.toString(messages("ated.date-format"))
              ))
            ),
            actions = Some(Actions(
              items = Seq(
                ActionItem(
                  href = controllers.propertyDetails.routes.IsFullTaxPeriodController.editFromSummary(changeLiability.id).url,
                  content = Text(messages("ated.edit")),
                  visuallyHiddenText = period.description
                )
              )
            ))
          )
        ),
        attributes = Map("id" -> "return-type-0")
      ))
    }
  </div>

  <div class="govuk-form-group govuk-!-margin-top-9">
  @changeLiability.period match {
    case Some(p) if (p.taxAvoidanceScheme.isEmpty && p.taxAvoidancePromoterReference.isEmpty) => {
      <div class="grid-wrapper row-border">
        <h2 id="avoidance-scheme-header-not-provided" class="govuk-heading-m">@messages("ated.property-details-summary.table.property-ated-details.avoidance-scheme.header")</h2>

        @govukSummaryList(SummaryList(
          rows = Seq(
            SummaryListRow(
              value = Value(
                content = Text(messages("ated.property-details-summary.field-blank"))
              ),
              actions = Some(Actions(
                items = Seq(
                  ActionItem(
                    href = controllers.propertyDetails.routes.PropertyDetailsTaxAvoidanceController.editFromSummary(changeLiability.id).url,
                    content = Text(messages("ated.edit")),
                    visuallyHiddenText = Some(messages("ated.property-details-summary.table.property-ated-details.avoidance-scheme.label"))
                  )
                )
              ))
            )
          ),
          attributes = Map("id" -> "avoidance-scheme-label")
        ))
      </div>
    }
    case Some(p) if (p.taxAvoidanceScheme.isDefined && p.taxAvoidancePromoterReference.isDefined) => {

      <div class="grid-wrapper govuk-!-margin-top-9">
        <h2 id="avoidance-scheme-header" class="govuk-heading-m">@messages("ated.property-details-summary.table.property-ated-details.avoidance-scheme.header")</h2>
      </div>

      @govukSummaryList(SummaryList(
        rows = Seq(
          SummaryListRow(
            key = Key(
              content = Text(messages("ated.property-details-summary.table.property-ated-details.avoidance-scheme.label"))
            ),
            value = Value(
              content = Text(p.taxAvoidanceScheme.getOrElse(""))
            ),
            actions = Some(Actions(
              items = Seq(
                ActionItem(
                  href = controllers.propertyDetails.routes.PropertyDetailsTaxAvoidanceController.editFromSummary(changeLiability.id).url,
                  content = Text(messages("ated.edit")),
                  visuallyHiddenText = Some(messages("ated.property-details-summary.table.property-ated-details.avoidance-scheme.label"))
                )
              )
            ))
          )
        ),
        attributes = Map("id" -> "avoidance-scheme-label")
      ))
      @govukSummaryList(SummaryList(
        rows = Seq(
          SummaryListRow(
            key = Key(
              content = Text(messages("ated.property-details-summary.table.property-ated-details.promoter-reference.label"))
            ),
            value = Value(
              content = Text(p.taxAvoidancePromoterReference.getOrElse(""))
            ),
            actions = Some(Actions(
              items = Seq(
                ActionItem(
                  href = controllers.propertyDetails.routes.PropertyDetailsTaxAvoidanceController.editFromSummary(changeLiability.id).url,
                  content = Text(messages("ated.edit")),
                  visuallyHiddenText = Some(messages("ated.property-details-summary.table.property-ated-details.promoter-reference.label"))
                )
              )
            ))
          )
        )
      ))
    }
    case _ => {
      <h2 id="avoidance-scheme-header-incomplete" class="govuk-heading-m govuk-!-margin-top-9">@messages("ated.property-details-summary.table.property-ated-details.avoidance-scheme.header")</h2>
      @govukSummaryList(SummaryList(
        rows = Seq(
          SummaryListRow(
            value = Value(
              content = HtmlContent(incomplete)
            ),
            actions = Some(Actions(
              items = Seq(
                ActionItem(
                  href = controllers.propertyDetails.routes.PropertyDetailsTaxAvoidanceController.editFromSummary(changeLiability.id).url,
                  content = Text(messages("ated.edit")),
                  visuallyHiddenText = Some(messages("ated.property-details-summary.table.property-ated-details.avoidance-scheme.label"))
                )
              )
            ))
          )
        )
      ))
    }
  }
  </div>

  <div class="govuk-form-group govuk-!-margin-top-9">
    <div class="grid-wrapper">
      <h2 id="supporting-info-header" class="govuk-heading-m">@messages("ated.property-details-summary.table.supporting-info.header")</h2>
    </div>
    @govukSummaryList(SummaryList(
      rows = Seq(
        SummaryListRow(
          key = Key(
            content = Text(messages("ated.property-details-summary.table.property-ated-details.additional-information.label"))
          ),
          value = Value(
            content = Text(changeLiability.period.map(v => v.supportingInfo.fold(messages("ated.property-details-summary.field-blank"))(x => if(x == "") messages("ated.property-details-summary.field-blank") else x)).getOrElse(""))
          ),
          actions = Some(Actions(
            items = Seq(
              ActionItem(
                href = controllers.propertyDetails.routes.PropertyDetailsSupportingInfoController.editFromSummary(changeLiability.id).url,
                content = Text(messages("ated.edit")),
                visuallyHiddenText = Some(messages("ated.property-details-summary.table.property-ated-details.additional-information.label"))
              )
            )
          ))
        )
      ),
      attributes = Map("id" -> "additional-information-label")
    ))
  </div>


  <div class="govuk-form-group govuk-!-margin-top-9">
    <h2 id="return-status-header" class="govuk-heading-m">@messages("ated.edit-liability.summary.bank-details.return-status.header")</h2>

    @govukSummaryList(SummaryList(
      rows = Seq(
        SummaryListRow(
          key = Key(
            content = Text(messages("ated.edit-liability.summary.bank-details.return-status.label"))
          ),
          value = Value(
            content = Text(messages("ated.property-details-summary.status.text"))
          )
        )
      ),
      attributes = Map("id" -> "return-status-label")
    ))

  </div>


  <div class="govuk-form-group">
    @if(returnType == "F") {
      <p id="ated-charge-text-further" class="govuk-body">@messages("ated.property-details-summary.table.revised-ated-charge-further.text")</p>
    }

    @if(returnType == "A") {
      <p id="ated-charge-text-amended" class="govuk-body">@messages("ated.property-details-summary.table.revised-ated-charge-amended.text")</p>
    }

    @if(returnType == "C") {
      <p id="ated-charge-text-changed" class="govuk-body">@messages("ated.property-details-summary.table.revised-ated-charge-changed.text")</p>
    }

    <span id="ated-charge-value" class="govuk-heading-xl">
    @changeLiability.calculated.flatMap(x => x.liabilityAmount.map(y => formattedPounds(y)))
    </span>

  </div>

  @govukInsetText(InsetText(
    content = Text(messages("ated.property-details-summary.saved-draft.text"))
  ))

  <div class="govuk-form-group">
    <a class="govuk-body govuk-link" href="@controllers.editLiability.routes.EditLiabilitySummaryController.viewPrintFriendlyEditLiabilityReturn(changeLiability.id.toString)" id="print-friendly-edit-liability-link" target="_blank">
    @messages("ated.edit-liability.summary.print.view")
    </a>
  </div>

  <div class="govuk-form-group">
    <a class="govuk-body govuk-link" href="@controllers.routes.AccountSummaryController.view" id="saved-returns-link">@messages("ated.property-details-summary.saved-returns.link.text")</a>
  </div>

  @formHelper(action = controllers.editLiability.routes.EditLiabilitySummaryController.submit(changeLiability.id.toString)) {

    @govukButton(Button(
      content = Text(messages("ated.continue")),
      attributes = Map("type" -> "submit", "id" -> "submit")
    ))

  }
}
