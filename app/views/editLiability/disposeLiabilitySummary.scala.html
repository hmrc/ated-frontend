@*
 * Copyright 2022 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import _root_.utils.PeriodUtils._
@import config.ApplicationConfig
@import play.twirl.api.HtmlFormat
@import uk.gov.hmrc.govukfrontend.views.html.components._
@import views.ViewUtils.titleBuilder
@import views.html.helpers.formattedPounds

@this(newMain: newMain,
        formHelper: FormWithCSRF,
        govukSummaryList: GovukSummaryList,
        govukBackLink: GovukBackLink,
        govukButton: GovukButton,
        govukInsetText: GovukInsetText)

@(disposeLiability: models.DisposeLiabilityReturn,
        serviceInfoContent: Html = HtmlFormat.empty,
        backLink: Option[String]
)(implicit authContext: StandardAuthRetrievals,
        messages: Messages,
        request: Request[AnyContent],
        appConfig: ApplicationConfig)

@incomplete = {
@Html("<span class=\"status\">" + messages("ated.label.incomplete") + "</span>")
}

@backLinkHtml = {
@if(backLink.isDefined) {
  @govukBackLink(BackLink(
    href = backLink.get,
    content = Text("Back")
  ))
}
}

@propertyDetailsAddress = {
  <span id="address-line-1">@messages(disposeLiability.formBundleReturn.propertyDetails.address.addressLine1)</span>
  <br>
  <span id="address-line-2">@messages(disposeLiability.formBundleReturn.propertyDetails.address.addressLine2)</span>
  <br>
@if(disposeLiability.formBundleReturn.propertyDetails.address.postalCode.isDefined) {
  <span id="address-postcode">@disposeLiability.formBundleReturn.propertyDetails.address.postalCode</span>
}
}

@disposeLiabilityDate = {
@disposeLiability.disposeLiability.map(x => x.dateOfDisposal.fold(
  incomplete
)
        (date => Html(date.toString(messages("ated.date-format"))))
)
}

@disposeLiabilityDateEdit = {
  <a href="@controllers.editLiability.routes.DisposePropertyController.editFromSummary(disposeLiability.id.toString)" id="edit-property-disposal-date">
    @messages("ated.edit") <span class="visuallyhidden">@messages("ated.dispose-property.summary.disposal-date-label")</span>
  </a>
}

@bankDetailsTypeOfAccountEdit = {
  <a href="@controllers.editLiability.routes.DisposeLiabilityBankDetailsController.editFromSummary(disposeLiability.id.toString)" id="edit-bank-details-type"> @messages("ated.edit")
    <span class="visuallyhidden">@messages("ated.edit-liability.summary.bank-details.type-of-account")</span>
  </a>
}

@bankDetailsAccountName = {
@disposeLiability.bankDetails.flatMap(_.bankDetails.map(_.accountName))
}

@bankDetailsAccountNameEdit = {
  <a href="@controllers.editLiability.routes.DisposeLiabilityBankDetailsController.editFromSummary(disposeLiability.id.toString)" id="edit-bank-details-account-name"> @messages("ated.edit")
    <span class="visuallyhidden">@messages("ated.edit-liability.summary.bank-details.account-holder-name")</span>
  </a>
}

@bankDetailsAccountNumber = {
@disposeLiability.bankDetails.flatMap(_.bankDetails.map(_.accountNumber))
}

@bankDetailsAccountNumberEdit = {
  <a href="@controllers.editLiability.routes.DisposeLiabilityBankDetailsController.editFromSummary(disposeLiability.id.toString)" id="edit-bank-details-account"> @messages("ated.edit")
    <span class="visuallyhidden">@messages("ated.edit-liability.summary.bank-details.account-number")</span>
  </a>
}

@bankDetailsAccountSortCode = {
@disposeLiability.bankDetails.flatMap(_.bankDetails.map(_.sortCode))
}

@bankDetailsAccountSortCodeEdit = {
  <a href="@controllers.editLiability.routes.DisposeLiabilityBankDetailsController.editFromSummary(disposeLiability.id.toString)" id="edit-bank-details-sortcode"> @messages("ated.edit")
    <span class="visuallyhidden">@messages("ated.edit-liability.summary.bank-details.sort-code")</span>
  </a>
}

@bankDetailsAccountNumberIBAN = {
@disposeLiability.bankDetails.flatMap(_.bankDetails.map(_.iban))
}

@bankDetailsAccountNumberIBANEdit = {
  <a href="@controllers.editLiability.routes.DisposeLiabilityBankDetailsController.editFromSummary(disposeLiability.id.toString)" id="edit-bank-details-iban"> @messages("ated.edit")
    <span class="visuallyhidden">@messages("ated.edit-liability.summary.bank-details.iban")</span>
  </a>
}

@bankDetailsAccountSwiftCode = {
@disposeLiability.bankDetails.flatMap(_.bankDetails.map(_.bicSwiftCode))
}

@bankDetailsAccountSwiftCodeEdit = {
  <a href="@controllers.editLiability.routes.DisposeLiabilityBankDetailsController.editFromSummary(disposeLiability.id.toString)" id="edit-bank-details-swift-code"> @messages("ated.edit")
    <span class="visuallyhidden">@messages("ated.edit-liability.summary.bank-details.bic-swift-code")</span>
  </a>
}

@bankDetailsIncompleteEdit = {
  <a href="@controllers.editLiability.routes.DisposeLiabilityHasBankDetailsController.editFromSummary(disposeLiability.id.toString)" id="edit-bank-name-details"> @messages("ated.edit")
    <span class="visuallyhidden">@messages("ated.edit-liability.summary.bank-details.supply-bank-details")</span>
  </a>
}

@newMain(title = titleBuilder(messages("ated.property-details-summary.title")),
  serviceInfoContent = serviceInfoContent) {

  @backLinkHtml

  <header>
    <h1 class="govuk-heading-xl">
      <span class="govuk-caption-xl">
        <span class="govuk-visually-hidden">
        @messages("ated.screen-reader.section")
        </span>
        @messages("ated.property-details.pre-header-dispose")
      </span>
      @messages("ated.property-details-summary.header")
    </h1>
  </header>

  <p id="details-text" class="govuk-body">@messages("ated.property-details-summary.details-text", periodStartDate(disposeLiability.formBundleReturn.periodKey.toInt).toString(messages("ated.date-format")), periodEndDate(disposeLiability.formBundleReturn.periodKey.toInt).toString(messages("ated.date-format")))</p>
  <section class="cya-wrapper" id="cya-property-details">
    <h2 id="cya-property-details-header" class="govuk-heading-m">@messages("ated.property-details-summary.table.property-details.header")</h2>

    @govukSummaryList(SummaryList(
      rows = Seq(
        SummaryListRow(
          key = Key(
            content = Text(messages("ated.property-details-summary.table.property-details.address.label"))
          ),
          value = Value(
            content = HtmlContent(propertyDetailsAddress)
          )
        ),
        SummaryListRow(
          key = Key(
            content = Text(messages("ated.dispose-property.summary.disposal-date-label"))
          ),
          value = Value(
            content = HtmlContent(disposeLiabilityDate)
          ),
          actions = Some(Actions(
            items = Seq(
              ActionItem(
                href = controllers.editLiability.routes.DisposePropertyController.editFromSummary(disposeLiability.id.toString).url,
                content = HtmlContent(messages("ated.edit")),
                visuallyHiddenText = Some(messages("ated.dispose-property.summary.disposal-date-label"))
              )
            )
          ))
        )
      )
    )
    )
  </section>

  <section class="cya-wrapper" id="cya-bank-details">

  @if(disposeLiability.bankDetails.map(_.hasBankDetails) == Some(true)) {

    <div class="grid-wrapper">
      <h2 class="govuk-heading-m" id="bank-details-header">@messages("ated.edit-liability.summary.bank-details.header")</h2>
    </div>

    @if(!disposeLiability.bankDetails.flatMap(_.bankDetails).isDefined) {

      @govukSummaryList(SummaryList(
        rows = Seq(
          SummaryListRow(
            key = Key(
              content = Text(messages("ated.edit-liability.summary.bank-details.type-of-account"))
            ),
            value = Value(
              content = HtmlContent(incomplete)
            ),
            actions = Some(Actions(
              items = Seq(
                ActionItem(
                  href = controllers.editLiability.routes.DisposeLiabilityBankDetailsController.editFromSummary(disposeLiability.id.toString).url,
                  content = HtmlContent(messages("ated.edit")),
                  visuallyHiddenText = Some(messages("ated.edit-liability.summary.bank-details.type-of-account"))
                )
              )
            ))
          )
        )
      ))

    } else {

      @if(disposeLiability.bankDetails.flatMap(_.bankDetails.flatMap(_.hasUKBankAccount)) == Some(true)) {

        @govukSummaryList(SummaryList(
          rows = Seq(
            SummaryListRow(
              key = Key(
                content = Text(messages("ated.edit-liability.summary.bank-details.type-of-account"))
              ),
              value = Value(
                content = Text(messages("ated.label-bank-account-type.uk"))
              ),
              actions = Some(Actions(
                items = Seq(
                  ActionItem(
                    href = controllers.editLiability.routes.DisposeLiabilityBankDetailsController.editFromSummary(disposeLiability.id.toString).url,
                    content = HtmlContent(messages("ated.edit")),
                    visuallyHiddenText = Some(messages("ated.edit-liability.summary.bank-details.type-of-account"))
                  )
                )
              ))
            ),
            SummaryListRow(
              key = Key(
                content = Text(messages("ated.edit-liability.summary.bank-details.account-holder-name"))
              ),
              value = Value(
                content = HtmlContent(bankDetailsAccountName),
              ),
              actions = Some(Actions(
                items = Seq(
                  ActionItem(
                    href = controllers.editLiability.routes.DisposeLiabilityBankDetailsController.editFromSummary(disposeLiability.id.toString).url,
                    content = HtmlContent(messages("ated.edit")),
                    visuallyHiddenText = Some(messages("ated.edit-liability.summary.bank-details.account-holder-name"))
                  )
                )
              ))

            ),
            SummaryListRow(
              key = Key(
                content = Text(messages("ated.edit-liability.summary.bank-details.account-number"))
              ),
              value = Value(
                content = HtmlContent(bankDetailsAccountNumber)
              ),
              actions = Some(Actions(
                items = Seq(
                  ActionItem(
                    href = controllers.editLiability.routes.DisposeLiabilityBankDetailsController.editFromSummary(disposeLiability.id.toString).url,
                    content = HtmlContent(messages("ated.edit")),
                    visuallyHiddenText = Some(messages("ated.edit-liability.summary.bank-details.account-number"))
                  )
                )
              ))
            ),
            SummaryListRow(
              key = Key(
                content = Text(messages("ated.edit-liability.summary.bank-details.sort-code"))
              ),
              value = Value(
                content = HtmlContent(bankDetailsAccountSortCode)
              ),
              actions = Some(Actions(
                items = Seq(
                  ActionItem(
                    href = controllers.editLiability.routes.DisposeLiabilityBankDetailsController.editFromSummary(disposeLiability.id.toString).url,
                    content = HtmlContent(messages("ated.edit")),
                    visuallyHiddenText = Some(messages("ated.edit-liability.summary.bank-details.sort-code"))
                  )
                )
              ))
            ))))

      } else {

        @govukSummaryList(SummaryList(
          rows = Seq(
            SummaryListRow(
              key = Key(
                content = Text(messages("ated.edit-liability.summary.bank-details.type-of-account"))
              ),
              value = Value(
                content = HtmlContent(messages("ated.label-bank-account-type.overseas"))
              ),
              actions = Some(Actions(
                items = Seq(
                  ActionItem(
                    href = controllers.editLiability.routes.DisposeLiabilityBankDetailsController.editFromSummary(disposeLiability.id.toString).url,
                    content = HtmlContent(messages("ated.edit")),
                    visuallyHiddenText = Some(messages("ated.edit-liability.summary.bank-details.type-of-account"))
                  )
                )
              ))
            ),
            SummaryListRow(
              key = Key(
                content = Text(messages("ated.edit-liability.summary.bank-details.account-holder-name"))
              ),
              value = Value(
                content = HtmlContent(bankDetailsAccountName),
              ),
              actions = Some(Actions(
                items = Seq(
                  ActionItem(
                    href = controllers.editLiability.routes.DisposeLiabilityBankDetailsController.editFromSummary(disposeLiability.id.toString).url,
                    content = HtmlContent(messages("ated.edit")),
                    visuallyHiddenText = Some(messages("ated.edit-liability.summary.bank-details.account-holder-name"))
                  )
                )
              ))

            ),
            SummaryListRow(
              key = Key(
                content = Text(messages("ated.edit-liability.summary.bank-details.iban"))
              ),
              value = Value(
                content = HtmlContent(bankDetailsAccountNumberIBAN)
              ),
              actions = Some(Actions(
                items = Seq(
                  ActionItem(
                    href = controllers.editLiability.routes.DisposeLiabilityBankDetailsController.editFromSummary(disposeLiability.id.toString).url,
                    content = HtmlContent(messages("ated.edit")),
                    visuallyHiddenText = Some(messages("ated.edit-liability.summary.bank-details.iban"))
                  )
                )
              ))
            ),
            SummaryListRow(
              key = Key(
                content = Text(messages("ated.edit-liability.summary.bank-details.bic-swift-code"))
              ),
              value = Value(
                content = HtmlContent(bankDetailsAccountSwiftCode)
              ),
              actions = Some(Actions(
                items = Seq(
                  ActionItem(
                    href = controllers.editLiability.routes.DisposeLiabilityBankDetailsController.editFromSummary(disposeLiability.id.toString).url,
                    content = HtmlContent(messages("ated.edit")),
                    visuallyHiddenText = Some(messages("ated.edit-liability.summary.bank-details.bic-swift-code"))
                  )
                )
              ))
            ))))
      }
    }

  } else {

    @if(!disposeLiability.bankDetails.isDefined) {
      @govukSummaryList(SummaryList(
        rows = Seq(
          SummaryListRow(
            key = Key(
              content = Text(messages("ated.edit-liability.summary.bank-details.supply-bank-details"))
            ),
            value = Value(
              content = HtmlContent(incomplete)
            ),
            actions = Some(Actions(
              items = Seq(
                ActionItem(
                  href = controllers.editLiability.routes.DisposeLiabilityHasBankDetailsController.editFromSummary(disposeLiability.id.toString).url,
                  content = HtmlContent(messages("ated.edit")),
                  visuallyHiddenText = Some(messages("ated.edit-liability.summary.bank-details.supply-bank-details"))
                )
              )
            ))
          )
        )
      ))
    }
  }
  </section>

  <section class="cya-wrapper" id="cya-return-status">
    <h2 id="return-status-header" class="govuk-heading-m">@messages("ated.property-details-summary.table.property-ated-details.return-status.header")</h2>

    @govukSummaryList(SummaryList(
      rows = Seq(
        SummaryListRow(
          key = Key(
            content = Text(messages("ated.edit-liability.summary.bank-details.return-status.label"))
          ),
          value = Value(
            content = HtmlContent(messages("ated.property-details-summary.status.text"))
          )
        )
      )
    ))
  </section>

  @if(disposeLiability.calculated.isDefined) {
    <div class="margin-bottom-default">
      <p id="ated-charge-text" class="govuk-body">
        @messages("ated.property-details-summary.table.ated-charge.text")
        <span class="govuk-heading-xl" id="ated-charge-value">
        @disposeLiability.calculated.map(x => formattedPounds(x.liabilityAmount))
        </span>
      </p>
    </div>
  }

  <div class="margin-bottom-default">
  @govukInsetText(InsetText(
    content = Text(messages("ated.property-details-summary.saved-draft.text"))
  ))
  </div>

  <p class="margin-bottom-default govuk-body">
    <a href="@controllers.editLiability.routes.DisposeLiabilitySummaryController.viewPrintFriendlyDisposeLiabilityReturn(disposeLiability.id.toString)" id="print-friendly-edit-liability-link" target="_blank">
    @messages("ated.dispose-property.summary.print.view")
    </a>
  </p>

  <p class="margin-bottom-default govuk-body">
    <a href="@controllers.routes.AccountSummaryController.view" id="saved-returns-link">@messages("ated.dispose-property.summary.save-as-draft-link")</a>
  </p>

  @if(DisposeLiabilityReturn.isComplete(disposeLiability)) {
    @formHelper(action = controllers.editLiability.routes.DisposeLiabilitySummaryController.submit(disposeLiability.id.toString)) {
      @govukButton(Button(
        content = Text(messages("ated.confirm-and-continue")),
        attributes = Map("type" -> "submit", "id" -> "submit")
      ))
    }
  }
}
