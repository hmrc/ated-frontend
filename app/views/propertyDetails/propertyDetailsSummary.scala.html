@*
 * Copyright 2022 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import config.ApplicationConfig
@import play.twirl.api.HtmlFormat
@import uk.gov.hmrc.govukfrontend.views.html.components._
@import uk.gov.hmrc.govukfrontend.views.html.components.implicits._
@import views.ViewUtils.titleBuilder
@import _root_.utils.PeriodUtils
@import _root_.utils.AtedUtils
@import views.html.helpers._

@this(newMain: newMain, 
      govukBackLink : GovukBackLink,
      govukButton : GovukButton,
      govukInsetText : GovukInsetText,
      govukSummaryList : GovukSummaryList,
      govukErrorSummary : GovukErrorSummary,
      govukTag : GovukTag,
      formHelper: FormWithCSRF)

@(propertyDetails: models.PropertyDetails,
periods : Seq[models.LineItem],
canSubmit: Boolean,
valuesToDisplay: Seq[models.LineItemValue],
serviceInfoContent: Html = HtmlFormat.empty,
backLink: Option[String])(implicit authContext: StandardAuthRetrievals, messages: Messages, request: Request[AnyContent], appConfig: ApplicationConfig)

@incomplete = {@messages("ated.label.incomplete")}

@backLinkHtml = {
    @if(backLink.isDefined) {
        @govukBackLink(BackLink(
        href = backLink.get,
        content = Text("Back")
        ))
    }
}

@propertyAddressOld = @{
        val address = Seq(propertyDetails.addressProperty.line_1, propertyDetails.addressProperty.line_2)
        val addressOptional = Seq(propertyDetails.addressProperty.line_3, propertyDetails.addressProperty.line_4, propertyDetails.addressProperty.postcode).flatten

        val finalAddress = address ++ addressOptional

        finalAddress.map { line =>
          <div><span>{s"""$line"""}</span></div>
        }

}

@incompleteTag = {<br>@govukTag(Tag(
  content = Text(messages("ated.label.incomplete")),
  classes = "govuk-tag--red"
))</br>}

@propertyAddress = {
  <div><span>@propertyDetails.addressProperty.line_1</span></div>
  <div><span>@propertyDetails.addressProperty.line_2</span></div>
  @propertyDetails.addressProperty.line_3.map { line =>
     <div><span>@line</span></div> 
  }
  @propertyDetails.addressProperty.line_4.map { line =>
     <div><span>@line</span></div> 
  }
  @propertyDetails.addressProperty.postcode.map { line =>
     <div><span>@line</span></div> 
  }
}

@taxAvoidanceReference= {
  <br>


}

@promoterReference= {
  <br>

}

@propertyTitle = {
  @propertyDetails.title.map(_.titleNumber).fold(messages("ated.property-details-summary.field-blank"))(x => if(x == "") messages("ated.property-details-summary.field-blank") else x)
}

@newMain(title = titleBuilder(messages("ated.property-details-summary.title")),
          serviceInfoContent = serviceInfoContent) {

@backLinkHtml

 <header>
    <h1 class="govuk-heading-l">
        <span class="govuk-caption-l"><span class="govuk-visually-hidden">@messages("ated.screen-reader.section") </span>@messages("ated.property-details.pre-header")</span>
        @messages("ated.property-details-summary.header")
    </h1>
 </header>

<p id="details-text" class="govuk-body">@messages("ated.property-details-summary.details-text", PeriodUtils.periodStartDate(propertyDetails.periodKey).toString(messages("ated.date-format")), PeriodUtils.periodEndDate(propertyDetails.periodKey).toString(messages("ated.date-format")))</p>


    <h2 id="property-details-header" class="govuk-heading-m">@messages("ated.property-details-summary.table.property-details.header")</h2>
    <header>
      <h1 class="govuk-heading-l">
          <span class="govuk-caption-l"><span class="govuk-visually-hidden">@messages("ated.screen-reader.section")
          @messages("ated.property-details-value.isValuedByAgent.header")
      </h1>
   </header>

    @govukSummaryList(SummaryList(
    rows = Seq(
      SummaryListRow(
        key = Key(
          content = Text(messages("ated.property-details-summary.table.property-details.address.label"))
        ),
        value = Value(
          content = HtmlContent(propertyAddress)
        ),
        actions = Some(Actions(
          items = Seq(
            ActionItem(
              href = controllers.propertyDetails.routes.PropertyDetailsAddressController.editFromSummary(propertyDetails.id).url,
              content = Text(messages("ated.edit"))
            )
          )
        ))
      ), 
      SummaryListRow(
        key = Key(
          content = Text(messages("ated.property-details-summary.table.property-details.title-number.label"))
        ),
        value = Value(
          content = HtmlContent(propertyTitle)
        ),
        actions = Some(Actions(
          items = Seq(
            ActionItem(
              href = controllers.propertyDetails.routes.PropertyDetailsTitleController.editFromSummary(propertyDetails.id).url,
              content = Text(messages("ated.edit"))
            )
          )
        ))
      )
    )
        ,attributes = Map("id" -> "address-summary")))

  <h2 id="property-value-header" class="govuk-heading-m">@messages("ated.property-details-summary.table.property-value.header")</h2>

  @if(false & AtedUtils.isEditSubmitted(propertyDetails)) {
      <span id="property-title-number-label" class="govuk-heading-m">@messages("ated.form-bundle.view.return.value.only")</span>
    @govukSummaryList(SummaryList(
      rows = Seq(
        SummaryListRow(
          key = Key(
            content = Text(messages("ated.property-details-summary.table.property-ated-details.avoidance-scheme.header"))
          ),
          value = Value(
            content = HtmlContent(incompleteTag)
          ),
          actions = Some(Actions(
            items = Seq(
              ActionItem(
                href = controllers.propertyDetails.routes.PropertyDetailsTaxAvoidanceController.editFromSummary(propertyDetails.id).url,
                content = Text(messages("ated.edit"))
            ))
        ))
      ))
    ))
    elseif(true & !AtedUtils.isEditSubmitted(propertyDetails))
          @govukSummaryList(SummaryList(
      rows = Seq(
        SummaryListRow(
          key = Key(
            content = Text(messages("ated.property-details-summary.table.property-ated-details.avoidance-scheme.header"))
          ),
          value = Value(
            content = HtmlContent(incompleteTag)
          ),
          actions = Some(Actions(
            items = Seq(
              ActionItem(
                href = controllers.propertyDetails.routes.PropertyDetailsOwnedBeforeController.editFromSummary(propertyDetails.id).url,
                content = Text(messages("ated.edit"))
            ))
        ))
      ))
    ))
  } else {
  @for((valueObj, index) <- valuesToDisplay.zipWithIndex) {
    @govukSummaryList(SummaryList(
      rows = Seq(
        SummaryListRow(
          key = Key(
            content = Text(messages(PeriodUtils.getPeriodValueMessage(index, valuesToDisplay.size)))
          ),
          value = Value(
            content = HtmlContent(formattedPounds(valueObj.propertyValue))
          ),
          actions = Some(Actions(
            items = Seq(
              ActionItem(
                href = if(AtedUtils.isEditSubmitted(propertyDetails)) {
controllers.editLiability.routes.EditLiabilityHasValueChangedController.editFromSummary(propertyDetails.id, Some(true)).url

} else {
controllers.propertyDetails.routes.PropertyDetailsOwnedBeforeController.editFromSummary(propertyDetails.id).url
},
                content = Text(messages("ated.edit"))
            ))
        ))
      ))
    ))
    }
  }
    @propertyDetails.value.map { propDetailsValue =>
        @propDetailsValue.isValuedByAgent match {
            case Some(true) => {
      @govukSummaryList(SummaryList(rows = Seq(
      SummaryListRow(
          key = Key(
            content = Text(messages("ated.form-bundle.view.isValuedByAgent.message"))
          ),
          value = Value(
            content = HtmlContent(messages("ated.property-details-period.yes"))
          ),
          actions = Some(Actions(
            items = Seq(
              ActionItem(
                href = controllers.propertyDetails.routes.PropertyDetailsProfessionallyValuedController.editFromSummary(propertyDetails.id).url,
                content = Text(messages("ated.edit"))
            ))
          ))
        ))))
            }
            case Some(false) => {
              @govukSummaryList(SummaryList(
                rows = Seq(
                SummaryListRow(
                    key = Key(
                    content = Text(messages("ated.form-bundle.view.isValuedByAgent.message"))
                  ),
                    value = Value(
                    content = Text(messages("ated.property-details-period.no"))
                  ),
                    actions = Some(Actions(
                    items = Seq(
                    ActionItem(
                      href = controllers.propertyDetails.routes.PropertyDetailsProfessionallyValuedController.editFromSummary(propertyDetails.id).url,
                      content = Text(messages("ated.edit"))
                    ))
                  ))
                ))
              ))
            }
            case None => { 
                    @govukSummaryList(SummaryList(
                      rows = Seq(
                      SummaryListRow(
                        key = Key(
                        content = Text(messages("ated.form-bundle.view.isValuedByAgent.message"))
                      ),
                        value = Value(
                        content = HtmlContent(incompleteTag)
                      ),
                        actions = Some(Actions(
                        items = Seq(
                        ActionItem(
                          href = controllers.propertyDetails.routes.PropertyDetailsProfessionallyValuedController.editFromSummary(propertyDetails.id).url,
                          content = Text(messages("ated.edit"))
                      ))
                    ))
                  ))
                ))
                }
        }
    }

  <h2 id="dates-of-liability-header" class="govuk-heading-m">@messages("ated.property-details-summary.table.dates-of-liability.header")</h2>
  @if(PeriodUtils.isListEmpty(periods)) {
    @govukSummaryList(SummaryList(
      rows = Seq(
        SummaryListRow(
          key = Key(
            content = Text(messages("ated.property-details-period.liability.return-type"))
          ),
          value = Value(
            content = HtmlContent(incompleteTag)
          ),
          actions = Some(Actions(
            items = Seq(
              ActionItem(
                href = controllers.propertyDetails.routes.IsFullTaxPeriodController.editFromSummary(propertyDetails.id).url,
                content = Text(messages("ated.edit"))
            ))
        ))
      ))
    ))
  } else {
  @for((period, index) <- periods.zipWithIndex) {
    @govukSummaryList(SummaryList(
      rows = Seq(
        SummaryListRow(
          key = Key(
            content = Text(messages((period.description).getOrElse("")))
          ),
          value = Value(
            content = Text(messages("ated.property-details-summary.table.period.text", period.startDate.toString(messages("ated.date-format")), period.endDate.toString(messages("ated.date-format"))))
          ),
          actions = Some(Actions(
            items = Seq(
              ActionItem(
                href = controllers.propertyDetails.routes.IsFullTaxPeriodController.editFromSummary(propertyDetails.id).url,
                content = Text(messages("ated.edit"))
            ))
        ))
      ))
    ))
  }
  }

<h2 id="avoidance-scheme-header-incomplete" class="govuk-heading-m">@messages("ated.property-details-summary.table.property-ated-details.avoidance-scheme.header")</h2>
  @propertyDetails.period match {
    case Some(p) if(p.taxAvoidanceScheme.isDefined && p.taxAvoidancePromoterReference.isDefined) => {
      @govukSummaryList(SummaryList(
      rows = Seq(
        SummaryListRow(
          key = Key(
            content = Text(messages("ated.property-details-summary.table.property-ated-details.avoidance-scheme.label"))
          ),
          value = Value(
            content = Text(p.taxAvoidanceScheme.getOrElse(""))
          ),
          actions = Some(Actions(
            items = Seq(
              ActionItem(
                href = controllers.propertyDetails.routes.PropertyDetailsTaxAvoidanceController.editFromSummary(propertyDetails.id).url,
                content = Text(messages("ated.edit"))
            ))
        ))
      ),
      SummaryListRow(
          key = Key(
            content = Text(messages("ated.property-details-summary.table.property-ated-details.promoter-reference.label"))
          ),
          value = Value(
            content = Text(p.taxAvoidancePromoterReference.getOrElse(""))
          ),
          actions = Some(Actions(
            items = Seq(
              ActionItem(
                href = controllers.propertyDetails.routes.PropertyDetailsTaxAvoidanceController.editFromSummary(propertyDetails.id).url,
                content = Text(messages("ated.edit"))
            ))
        ))
      )
      )
    ))
    }
    case Some(p) if(p.isTaxAvoidance.isDefined) => {
      @govukSummaryList(SummaryList(
      rows = Seq(
        SummaryListRow(
          key = Key(
            content = Text(messages("ated.property-details-summary.table.property-ated-details.avoidance-scheme.header"))
          ),
          value = Value(
            content = Text(messages("ated.property-details-period.no"))
          ),
          actions = Some(Actions(
            items = Seq(
              ActionItem(
                href = controllers.propertyDetails.routes.PropertyDetailsTaxAvoidanceController.editFromSummary(propertyDetails.id).url,
                content = Text(messages("ated.edit"))
            ))
        ))
      ))
    ))
    }
    case _ => {
      @govukSummaryList(SummaryList(
      rows = Seq(
        SummaryListRow(
          key = Key(
            content = Text(messages("ated.property-details-summary.table.property-ated-details.avoidance-scheme.header"))
          ),
          value = Value(
            content = HtmlContent(incompleteTag)
          ),
          actions = Some(Actions(
            items = Seq(
              ActionItem(
                href = controllers.propertyDetails.routes.PropertyDetailsTaxAvoidanceController.editFromSummary(propertyDetails.id).url,
                content = Text(messages("ated.edit"))
            ))
        ))
      ))
    ))
    }
  }

  <h2 class="govuk-heading-m" id="supporting-info-header">@messages("ated.property-details-summary.table.supporting-info.header")</h2>

@propertyDetails.period.map(v =>
  govukSummaryList(SummaryList(
    rows = Seq(
      SummaryListRow(
        key = Key(
          content = Text(messages("ated.property-details-summary.table.property-ated-details.additional-information.label"))
        ),
        value = Value(
          content = Text(v.supportingInfo.fold(messages("ated.property-details-summary.field-blank"))(x => if(x == "") messages("ated.property-details-summary.field-blank") else x))
        ),
        actions = Some(Actions(
          items = Seq(
            ActionItem(
              href = controllers.propertyDetails.routes.PropertyDetailsSupportingInfoController.editFromSummary(propertyDetails.id).url,
              content = Text(messages("ated.edit"))
          ))
      ))
    ))
  ))
)


  <h2 class="govuk-heading-m" id="return-status-header">@messages("ated.property-details-summary.table.property-ated-details.return-status.header")</h2>

  @govukSummaryList(SummaryList(
    rows = Seq(
      SummaryListRow(
        key = Key(
          content = Text(messages("ated.property-details-summary.table.property-ated-details.return-status.label"))
        ),
        value = Value(
          content = Text(messages("ated.property-details-summary.status.text"))
        ))
  )))

  <p class="govuk-body-m">@messages("ated.property-details-summary.table.ated-charge.text")</p>

  <p class="govuk-heading-xl" id="ated-charge-text">
    <span id="ated-charge-value" class="heading-xlarge form-group">
      @if(propertyDetails.calculated.isEmpty) {
      @messages("ated.unknown-amount.text")
      } else {
      @propertyDetails.calculated.flatMap(x=>x.liabilityAmount.map(y=>formattedPounds(y)))
      }
    </span>
  </p>

  @govukInsetText(InsetText(
    content = Text(messages("ated.property-details-summary.saved-draft.text"))
  ))

<ul class="govuk-list">
  <li>
      <a href="@controllers.propertyDetails.routes.PropertyDetailsSummaryController.viewPrintFriendlyLiabilityReturn(propertyDetails.id)" id="print-friendly-liability-link" class="govuk-link">@messages("ated.property-details-summary.print.view")</a>
  </li>
  <li>
      <a href="@controllers.routes.AccountSummaryController.view" class="govuk-link">@messages("ated.property-details-summary.saved-returns.link.text")</a>
  </li>
  <li>
      <a href="@controllers.propertyDetails.routes.PropertyDetailsSummaryController.deleteDraft(propertyDetails.id, propertyDetails.periodKey)" class="govuk-link">@messages("ated.property-details-summary.delete-draft.link.text")</a>
  </li>
</ul>

@formHelper(action=controllers.propertyDetails.routes.PropertyDetailsSummaryController.submit(propertyDetails.id)) {
  @if(propertyDetails.calculated.isEmpty){
  } else {
  @if(canSubmit && propertyDetails.period.isDefined && !PeriodUtils.isListEmpty(valuesToDisplay) && !PeriodUtils.isListEmpty(periods)) {
@govukButton(Button(
content = Text(messages("ated.confirm-and-continue")),
attributes = Map("id" -> "submit-enabled")
))
  } else {
  <p id="submit-disabled-text">@messages("ated.property-details-summary.submit-disabled-text")</p>
    }
  }

}

}
